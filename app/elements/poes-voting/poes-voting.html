<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/chart-elements/chart-elements.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">


<dom-module id="poes-voting">
  <template>
  <script src="../../bower_components/moment/moment.js"></script>
      <ipfs-upload hidefileinput host="/ip4/109.123.70.141/tcp/5001" ipfs="{{ipfs}}">
      </ipfs-upload>
    <style>
      :host {
        display: block;
        background-color: white;
        height: 100vh;
      }

      .canvaskf {
        @apply(--layout-start);
        box-sizing:border-box;
        padding: 30px;
        background-color: white;
      }

      iron-selector {
        @apply(--layout-vertical);
      }

    .iron-selected {
      background: #ccc;
    }

    .iron-selected::after {
      content: 'momenteel uw stem';
    }

    .square-chart {
      margin-bottom: 20px;
    }

    paper-toolbar {
      background-color: #D18E7D;
      @apply(--layout-horizontal);
      @apply(--layout-wrap);
      @apply(--layout-center-center);
    }

    .keuzeoptie {
      @apply(--layout-horizontal);
      margin-bottom: 10px;
    }

    .bolleke {
      margin-right: 10px;
    }

    </style>
    <template is="dom-if" if="{{voteactive}}">
      <div>
        <paper-toolbar>
          <div class="flex"></div>
          <poes-avatar on-tap="topussybase" poesnr="{{poezenimage}}"></poes-avatar>
        </paper-toolbar>
        <div class="canvaskf">
        <h2 on-tap="renderchart">{{vraag}}</h2>
        <chart-pie data="{{chartdata}}" class="square-chart" id="chart"></chart-pie>
        <iron-selector attr-for-selected="key" selected="0" class="choice">
         <div class="keuzeoptie" key="0">
            <poes-kleurbolleke class="bolleke" kleur="{{kleur1}}"></poes-kleurbolleke>
            <div class="label flex">{{optie1}}</div>
            <div>{{optie1votes}}</div>
          </div>
          <div class="keuzeoptie" key="1">
            <poes-kleurbolleke class="bolleke" kleur="{{kleur2}}"></poes-kleurbolleke>
            <div class="label flex">{{optie2}}</div>
            <div>{{optie2votes}}</div>
          </div>
          <div class="keuzeoptie" key="2">
            <poes-kleurbolleke class="bolleke" kleur="{{kleur3}}"></poes-kleurbolleke>
            <div class="label flex">{{optie3}}</div>
            <div>{{optie3votes}}</div>
          </div>
        </iron-selector>
        

        <p>Einde van deze stemronde: <b>{{resttijd}}</b></p>

        <p>Maandag gaat de doos enkel open voor poezen die de winnende keuze hebben gemaakt.</p>
        
        </div>
      </div>
    </template>
    <template is="dom-if" if="{{!voteactive}}">
      <div>
        <paper-toolbar>
          <div class="flex"></div>
          <poes-avatar on-tap="topussybase" poesnr="{{poezenimage}}"></poes-avatar>
        </paper-toolbar>
        <div class="canvaskf">
        <p>Het stemmen is afgelopen.</p>
        <h2 on-tap="renderchart">Wat moet er vanaf maandag in de poezendoos zitten?</h2>
        <chart-pie data="{{chartdata}}" class="square-chart" id="chart"></chart-pie>
          <div class="keuzeoptie">
            <poes-kleurbolleke class="bolleke" kleur="{{kleur1}}"></poes-kleurbolleke>
            <div class="label flex">{{optie1}}</div>
            <div>{{optie1votes}}</div>
          </div>
          <div class="keuzeoptie">
            <poes-kleurbolleke class="bolleke" kleur="{{kleur2}}"></poes-kleurbolleke>
            <div class="label flex">{{optie2}}</div>
            <div>{{optie2votes}}</div>
          </div>
          <div class="keuzeoptie">
            <poes-kleurbolleke class="bolleke" kleur="{{kleur3}}"></poes-kleurbolleke>
            <div class="label flex">{{optie3}}</div>
            <div>{{optie3votes}}</div>
          </div>

        <template is="dom-if" if="{{winner}}">
          <p>Jij stemde voor de winnende keuze!</p>
          <paper-button raised>OPEN DE DOOS</paper-button>
        </template>

        <template is="dom-if" if="{{!winner}}">
          <p>Helaas, je hoort niet bij de winnaars.</p>
          <p>Probeer het volgende week nog eens!</p>
        </template>


        </div>
      </div>
    </template>

         
 <paper-toast on-tap="closetoast" id="toast1" duration="0"></paper-toast>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'poes-voting',

      properties: {
        votekey: {
          type: String,
          observer: 'renderchart'
        },
        voteactive: {
          type: Boolean,
          value: true
        },
        winner: {
          type: Boolean,
          value: true
        },
        contractaddress: {
          type: String,
          observer: "_hascontractaddress"
        },
        voteipfs: {
          type:String
        },
        ipfs: {
          type: String,
          observer: "_ipfschanged"
        }
      },

      showtoast: function(msg){
        this.$.toast1.text = this.$.toast1.text+'\n\n'+msg;
        this.$.toast1.open();
      },


      attached: function(){
      },

      _ipfschanged: function(){
        var self =this;

        if (this.ipfs){
        this.ipfs.cat(this.voteipfs, function(err, res) {


        var buf = '';
        res
          .on('error', (err) => {
            throw err
          })
          .on('data', (data) => {
            buf += data
          })
          .on('end', () => {
//            console.log('buffer',buf);
            self.vote = JSON.parse(buf);
            console.log(self.vote);
            var votedata = self.vote;
            self.vraag = votedata.vraag;
            self.optie1 = votedata.optie1;
            self.optie2 = votedata.optie2;
            self.optie3 = votedata.optie3;
            self.kleur1 = votedata.kleur1;
            self.kleur2 = votedata.kleur2;
            self.kleur3 = votedata.kleur3;

            var eindtijd = votedata.enddate +" "+votedata.endtime;

            self.resttijd = moment(eindtijd).fromNow();
            console.log(self.resttijd);

            self.chartdata = [{
            key: 0,
            value: 300,
            color:votedata.kleur1,
            highlight: "#FF5A5E",
            label: votedata.optie1
          },

          {
            key: 1,
            value: 50,
            color: votedata.kleur2,
            highlight: "#5AD3D1",
            label: votedata.optie2
          },

          {
            key: 2,
            value: 100,
            color: votedata.kleur3,
            highlight: "#FFC870",
            label: votedata.optie3
        }];

            //self.chartdata = chartdata;
            self.$.chart.updateChart();

            self.showtoast("Chart updated. Click to close.");

            console.log(votedata.vraag)
            self.contractaddress = self.vote.contractaddress;
            // de rest gaat via de observer van contractaddress
          });
        });

        }else{
          console.log('failed to read IPFS object : not available');
        }
      },

      topussybase: function(){
        var app = document.getElementById("stage");
        console.log(app);
        app.topussybase();
      },

      renderchart: function(){
   
      },

      _hascontractaddress: function() {
        var self = this;
        this.contracturl = this.resolveUrl('../../contracts/PoezenVoting.json');
        this.importHref(this.contracturl, function(e) {
          // console.log(e.target.import.body.innerText);
          self.contractjson = JSON.parse(e.target.import.body.innerText);
          // TODO verwijder mij !!! ASAP !
          self.castVote();


        }, function(e) {
          console.log('ERROR!');
        });
      },


      castVote: function() {
        var self = this;

        //dees binden aan de 
        self.vote = 2;

        self.web3.eth.getGasPrice(function(err, result) {

          var MyContract = self.web3.eth.contract(self.contractjson.abi);
          var myContractInstance = MyContract.at(self.contractaddress);


          var gasPrice = result.toNumber(10);

          var options = {
            from: self.account,
            //value: 1 * 1e18,
            gas: 3141590,
            gasPrice: gasPrice,
            nonce: Math.floor(Math.random(999999)) + new Date().getTime(),
          };

          var result = myContractInstance.vote.sendTransaction(self.vote, options,
            function(err, result) {
              if (err != null) {
                console.log(err);
                console.log("ERROR: Transaction didn't go through. See console.");
              } else {
                console.log("Transaction Successful!");
                console.log(result);
              }
            }
          );


        });
      },

      closetoast: function(){
        this.$.toast1.close();
      }

    });
  })();
  </script>
</dom-module>
