<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../poes-aai/poes-aai.html">
<link rel="import" href="../../bower_components/chart-elements/chart-elements.html">


<dom-module id="poes-voting">
  <template>

    <script src="../../bower_components/moment/min/moment-with-locales.min.js"></script>
    <script src="../../bower_components/underscore/underscore-min.js"></script>


      <ipfs-upload hidefileinput host="/ip4/109.123.70.141/tcp/5001" ipfs="{{ipfs}}">
      </ipfs-upload>
    <style>
      :host {
        display: block;
        width: 100%;
        height: 600px;
      }

      neon-animated-pages {
        height: 100%;
      }

      h1 {
        @apply(--theme-font-title);
        text-align: center;
      }

      h2 {
        @apply(--theme-font-subhead);
        margin: 0px;        
        padding: 0px;        
      }

      p {
        margin: 0px;        
        padding: 0px;
      }

      .canvas {
        width: 100%;
        @apply(--layout-vertical);
        @apply(--layout-center-center);
        box-sizing:border-box;
        padding: 0px 30px 30px 30px;
        background-color: var(--pink-theme-color);
      }


      .bigp {
        font-size: 22px;            
      }

      .voteheader {
        padding: 50px 50px 0px 50px;
        @apply(--layout-vertical);
        @apply(--layout-center);
      }

      .voteheader h1 {
        font-size: 54px;
/*        background-color: rgba(0,0,0,0.05);*/
        box-sizing:border-box;
        padding: 10px 20px 10px 20px;
      }

      .votebody {
        background-color: green;
      }


      .graph {
        width: 100px;
        height: 100px;
        min-height: 100px;
        background-color: rgba(0,0,0,0.05);
      }

      .square-chart {
        width: 100px;
        height: 100px;
      }

      .themefont {
        @apply(--theme-font-general);
      }

     .votething {
        width: 100%;
        max-width: 300px;
        @apply(--layout-horizontal);
        @apply(--layout-start);
        @apply(--layout-wrap);        
        box-sizing:border-box;
        margin: 6px;
        background-color: rgba(0,0,0,0.05);
      }

      .votethingtxt {
        box-sizing:border-box;
        padding: 20px;
        @apply(--layout-vertical);
        @apply(--layout-start); 
      }

      .votethingimg {
        width: 100%;
        height: 200px;
        overflow: hidden;
      }

      .votethingimg img {
        min-width: 100%;
        min-height: 100%;
      }



      .winner {

      }


      .winnerlabel {
        background-color: var(--oranje-theme-color);
        width: 100%;
        color: white;
        box-sizing:border-box;
        padding: 5px;
        margin: 0px;
        text-align: center;
      }

      .timestamp {
        margin-bottom: 10px;
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      .timestamp img {
        width: 15px;
        height: 15px;
        margin-right: 10px;
      }


      .votethings {
        width: 100%;
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        @apply(--layout-start);
        @apply(--layout-wrap);
      }

      .otherresults {
        width: 100%;
        box-sizing:border-box;
        padding: 20px;
        max-width: 500px;
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }


      .ownvote {
        width: 100%;
        min-height: 100px;
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
        @apply(--layout-wrap);
        box-sizing:border-box;
        padding: 20px 0px 50px 0px;
      }

      .mainbutton {
        outline: 0; 
        margin: 30px;
        box-sizing:border-box;
        border-radius: 8px;
        cursor: pointer;
        @apply(--theme-font-button);
        text-decoration: none;
        background-color: var(--pink-theme-color);
        padding: 20px 25px 20px 25px;
        font-size: 28px;
        border: 1px solid black;
        color: black;
      }

      .mainbutton:hover {
        background-color: var(--pinktwee-theme-color);
      }


      .mediumbutton {
        outline: 0; 
        margin: 20px;
        box-sizing:border-box;
        border-radius: 8px;
        cursor: pointer;
        @apply(--theme-font-button);
        background-color: var(--pinktwee-theme-color);
        border:none;
    /*        border: 1px solid rgba(0,0,0,0.5); */
        padding: 16px;
        font-size: 22px;
        @apply(--layout-horizontal);
        @apply(--layout-center-center);  
      }


      .ownvote .minibtn {
        outline: 0; 
        margin: 5px 5px 5px 0px;
        box-sizing:border-box;
        border-radius: 8px;
        cursor: pointer;
        @apply(--theme-font-button);
        text-decoration: none;
        background-color: rgba(0,0,0,0.05);
        padding: 20px;
        font-size: 20px;
        color: black;
        text-decoration: underline;
        border: none;


      }


      .ownvotetxt {
        margin: 20px 0px 20px 0px;
        width: 100%;
        @apply(--layout-horizontal);
        @apply(--layout-center-center); 
      }

      .ownvotetxt p {
      @apply(--theme-font-general);

      line-height: 22px;
      margin: 0px;

      font-weight: 300;
      font-size: 22px;
      line-height: 28px;
      }




      .givevote {
        width: 100%;
        min-height: 100px;
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
        @apply(--layout-wrap);
        box-sizing:border-box;
        padding: 20px 0px 50px 0px;
      }


       .bolleke {
        visibility: hidden;
       }


      #voteselector .iron-selected {
        background-color: var(--blue-theme-color);
        color: white;
         -moz-box-shadow:    3px 3px 3px 3px rgba(0,0,0,0.05);
        -webkit-box-shadow: 3px 3px 3px 3px rgba(0,0,0,0.05);
        box-shadow:         3px 3px 3px 3px rgba(0,0,0,0.05);
      }

       #voteselector .iron-selected h1  {
       color: white;
      }

       #voteselector .iron-selected .bolleke  {
        visibility: visible;
      }

      #voteselector .iron-selected img {
        opacity: 1;
        box-sizing: border-box;
      }

/*      .voteitem {
        width: 80%;
        background-color: rgba(0,0,0,0.05);
        border-bottom: 1px solid var(--pinktwee-theme-color);
        overflow: hidden;
        @apply(--layout-horizontal);
        @apply(--layout-start);
        @apply(--layout-wrap);
        margin: 5px;
      }



      .voteitemimg {
        height: 90px;
        width: 90px;
        max-width: 20%;

        overflow: hidden;
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
        background-color: white;
      }

      .voteitemimg img {
        width: 100%;
        opacity: 0.5;
      }


      .voteitemtxt {
        min-width: 230px;
        max-width: 80%;
        box-sizing:border-box;
        padding: 20px 20px 15px 20px; 
        @apply(--layout-vertical);
        @apply(--layout-start);
      }

      .voteitemtxt h1 {
        font-size: 36px;
        line-height: 1;
      }


      .voteitemtxt p {
      font-size: 15px;
      font-weight: 300;
      margin: 0px;
      padding: 0px;
            }*/

      .small {
        font-size: 9px;
      }

      iron-selector {
        width: 100%;
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
        @apply(--layout-start);
        @apply(--layout-center-justified);

      }


      .whiteback {
        background-color: rgba(255,255,255,0.35);
      }


      .whiteback img {
        opacity: 0.9;
      }

      .blueborder {
        box-sizing:border-box;
        border: 2px solid var(--blue-theme-color);
      }
      .blueborder img {
        opacity: 0.9;
      }


      .bluecolor h1 {
        color: var(--blue-theme-color);
      }


@media all and (min-width: 0) and (max-width: 360px) and (orientation: portrait) {

     .votething {
        width: 100%;
        max-width: 600px;
      }

      .votethingimg {
        width: 90px;
        height: 90px;
        overflow: hidden;
      }

      .votethingimg img {
        min-width: 100%;
        min-height: 100%;
      }
      .votethingtxt {
        padding: 15px;
      }

      .votethingtxt h1 {
        font-size: 24px;
        line-height: 28px;
      }
      .votethingtxt p {
        font-size: 16px;
      }
      .small {
        font-size: 9px;
      }
}
  /* mobile-large */
  @media all and (min-width: 361px) and (orientation: portrait) {
     .votething {
        width: 100%;
        max-width: 600px;
      }
      .votethingimg {
        width: 90px;
        height: 90px;
        overflow: hidden;
      }

      .votethingimg img {
        min-width: 100%;
        min-height: 100%;
      }
      .votethingtxt {
        padding: 15px;
      }
      .votethingtxt h1 {
        font-size: 24px;
        line-height: 28px;
      }
      .votethingtxt p {
        font-size: 16px;
      }
      .small {
        font-size: 9px;
      }
   }
  /* mobile-small-landscape */
  @media all and (min-width: 0) and (max-width: 480px) and (orientation: landscape) {
     .votething {
        width: 100%;
        max-width: 600px;
      }

      .votethingimg {
        width: 90px;
        height: 90px;
        overflow: hidden;
      }

      .votethingimg img {
        min-width: 100%;
        min-height: 100%;
      }
      .votethingtxt {
        padding: 15px;
      }

      .votethingtxt h1 {
        font-size: 24px;
        line-height: 28px;
      }
      .votethingtxt p {
        font-size: 16px;
      }
      .small {
        font-size: 9px;
      }
   }



 @media all and (min-width: 841px) and (max-width: 1280px) and (orientation: landscape) { 
      .voteitem {
        width: 30%;
        max-width: 300px;
      }

      .voteitemtxt {
        width: 100%;
      }

      .voteitemimg {
        height: 100%;
        width: 100%;
        max-width: 400px;
        height: 200px;

      }

 }
  /* desktop-medium */
  @media all and (min-width: 841px) and (max-width: 1280px) and (max-aspect-ratio: 4/3) { 
      .voteitem {
        width: 30%;
        max-width: 300px;
      }
      .voteitemtxt {
        width: 100%;
      } 

      .voteitemimg {
        height: 100%;
        width: 100%;
        max-width: 400px;
        height: 200px;
      }
  }

  /* desktop-large */
  @media all and (min-width: 1281px) and (max-width: 1600px) { 
       .voteitem {
        width: 30%;
        max-width: 400px;
      }

      .voteitemtxt {
        width: 100%;
      }

      .voteitemimg {
        height: 100%;
        width: 100%;
        max-width: 400px;
        height: 200px;
      }
  }
  /* desktop-xlarge */
  @media all and (min-width: 1601px) and (max-width: 1920px) { 
        .voteitem {
        width: 30%;
        max-width: 400px;
      }
      .voteitemtxt {
        width: 100%;
      }

      .voteitemimg {
        height: 100%;
        width: 100%;
        max-width: 400px;
        height: 200px;
      }


}


    </style>


    <div class="voteheader">
      <h1>{{vraag}}</h1>
    </div>


    <div class="votebody">
    <neon-animated-pages selected="{{votestate}}" 
            entry-animation="slide-from-right-animation"
            exit-animation="slide-from-right-animation"
            attr-for-selected="vote-route">

      <neon-animatable vote-route="votecounts">
        <div class="canvas">
          <div class="votethings">

              <div class="votething winner">
                <div class="votethingimg">
                  <img id="img1" src="http://gateway.ipfs.io/ipfs/{{winimg}}" />
                </div>
                <div class="votethingtxt">
                  <h1>{{winoptie}}</h1>
                  <p><span>{{winvotes}}</span> stemmen</p>
                </div>
                <div class="winnerlabel">
                <p class="themefont">Dit is momenteel de winnende optie!</p>
                </div>
              </div>
 
              <div class="votething">
                <div class="votethingimg">
                  <img id="img1" src="http://gateway.ipfs.io/ipfs/{{img1}}" />
                </div>
                <div class="votethingtxt">       
                  <h1>{{optie1}}</h1>
                  <p><span>{{votes1}}</span> stemmen</p>
                </div>  
              </div>

              <div class="votething">
                <div class="votethingimg">
                  <img id="img3" src="http://gateway.ipfs.io/ipfs/{{img3}}" />
                </div>
                <div class="votethingtxt">       
                  <h1>{{optie3}}</h1>
                  <p><span>{{votes3}}</span> stemmen</p>
                </div>  
              </div>
            </div> 

            <div class="ownvote">
              <template is="dom-if" if="{{!voted}}">
              <button class="mainbutton" on-tap="toCast">Stem mee!</button>
              </template>
              <div class="timestamp"><img src="../../images/time.svg"><p>Het stemmen eindigt <span>{{resttijd}}</span></p></div>    
              <template is="dom-if" if="{{voted}}">
              <div class="ownvotetxt">
                <poes-aai catnumber="{{poezenimage}}"></poes-aai>
                <p>Jij stemde op jouw keuze.</p>
              </div>
              <button class="minibtn" on-tap="toCast">Mijn stem veranderen</button>
              </template>
            </div>
        </div> 
      </neon-animatable>

      <neon-animatable vote-route="castvote">
        <div class="canvas">
            <iron-selector
            id="voteselector"
            attr-for-selected="key"
            selected="{{currentchoice}}"
            on-iron-select="castVote"
            >
              <div class="votething bluecolor" key="1">
                <div class="votethingimg">
                  <img id="img1" src="http://gateway.ipfs.io/ipfs/{{img1}}" />
                </div>
                <div class="votethingtxt">
                  <h1>{{optie1}}</h1>
                  <p>(<span>{{votes1}}</span> stemmen)</p>
                </div>  
              </div>
              <div class="votething bluecolor" key="2">
                <div class="votethingimg">
                  <img id="img2" src="http://gateway.ipfs.io/ipfs/{{img2}}" />
                </div>
                <div class="votethingtxt">       
                  <h1>{{optie2}}</h1>
                  <p>(<span>{{votes2}}</span> stemmen)</p>
                </div>  
              </div>
              <div class="votething bluecolor" key="3">
                <div class="votethingimg">
                  <img id="img3" src="http://gateway.ipfs.io/ipfs/{{img3}}" />
                </div>
                <div class="votethingtxt">      
                  <h1>{{optie3}}</h1>
                  <p>(<span>{{votes3}}</span> stemmen)</p>
                </div>  
              </div>
        </iron-selector>

        <div class="givevote">
          <button  class="mainbutton">Mijn stem uitbrengen voor optie <span>{{currentchoice}}</span></button>
        </div>
      </div>
      </neon-animatable>



      <neon-animatable vote-route="vote2">
        <div class="canvaspink">

        </div>
      </neon-animatable>

</neon-animated-pages>
</div>
<!--     <template is="dom-if" if="{{voteactive}}">
      <div>
        <paper-toolbar>
          <div class="flex"></div>
          <poes-avatar on-tap="topussybase" poesnr="{{poezenimage}}"></poes-avatar>
        </paper-toolbar>
        <div class="canvaskf">
        <h2 on-tap="renderchart">Wat moet er vanaf maandag in de poezendoos zitten?</h2>
        <chart-pie data="{{chartdata}}" class="square-chart" id="chart"></chart-pie>
        <iron-selector attr-for-selected="key" selected="{{currentchoice}}" on-iron-select="castVote" class="choice">
        <template is="dom-repeat" items="{{chartdata}}">
          <div class="keuzeoptie" key="{{item.key}}">
            <poes-kleurbolleke class="bolleke" kleur="{{item.color}}"></poes-kleurbolleke>
            <div class="label flex">{{item.label}}</div>
            <div>{{item.value}}</div>
          </div>
        </template>
        </iron-selector>
        <p>Bgin van deze stemronde <b>{{starttijd}}</b></p>
        <p>Einde van deze stemronde <b>{{resttijd}}</b></p>
        <p>Maandag gaat de doos enkel open voor poezen die de winnende keuze hebben gemaakt.</p>
        
        </div>
      </div>
    </template>

    

    als de voting niet meer actief is

    <template is="dom-if" if="{{!voteactive}}">
      <div>
        <paper-toolbar>
          <div class="flex"></div>
          <poes-avatar on-tap="topussybase" poesnr="{{poezenimage}}"></poes-avatar>
        </paper-toolbar>
        <div class="canvaskf">
        <p>Het stemmen is afgelopen.</p>
        <h2 on-tap="renderchart">Wat moet er vanaf maandag in de poezendoos zitten?</h2>
        <chart-pie data="{{chartdata}}" class="square-chart" id="chart"></chart-pie>
        <template is="dom-repeat" items="{{chartdata}}">
          <div class="keuzeoptie" key="{{item.key}}">
            <poes-kleurbolleke class="bolleke" kleur="{{item.color}}"></poes-kleurbolleke>
            <div class="label flex">{{item.label}}</div>
            <div>{{item.value}}</div>
          </div>
        </template>

        <template is="dom-if" if="{{winner}}">
          <p>Jij stemde voor de winnende keuze!</p>
          <paper-button raised>OPEN DE DOOS</paper-button>
        </template>

        <template is="dom-if" if="{{!winner}}">
          <p>Helaas, je hoort niet bij de winnaars.</p>
          <p>Probeer het volgende week nog eens!</p>
        </template>


        </div>
      </div>
    </template> -->
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'poes-voting',

      properties: {
        votekey: {
          type: String
        },
        voteactive: {
          type: Boolean,
          value: true
        },
        winner: {
          type: Boolean,
          value: true
        },
        contractaddress: {
          type: String,
          observer: "_hascontractaddress"
        },
        voteipfs: {
          type:String
        },
        ipfs: {
          type: String,
          observer: "_ipfschanged"
        },
        votestate: {
          type:String,
          observer: '_votestatechanged'          
        },
        voted: {
          type: Boolean,
          value: false,
          observer: '_votedchanged'          
        },
        chartisthere: {
          type: Boolean,
          value: false
        },
        winkey: {
          type: String,
          observer: '_winkey'
        }
      },

      attached: function(){
        this.votestate = "votecounts";
        this.chartisthere = false;

      },

      _votestatechanged: function(){
        console.log('votestate changed to',this.votestate);
      },

      _votedchanged: function(){
        console.log('I have voted?',this.voted);
      },

      getIPFS: function(hash, fn){
        this.ipfs.cat(hash, function(err, res) {
          var buf = '';
          res.on('data', (data) => {
            buf += data
          })
          .on('end', () => {
            //console.log(buf);
            fn(buf);
          });
        });
      },

      _ipfschanged: function(){
        var self =this;

        if (this.ipfs){
        this.ipfs.cat(this.voteipfs, function(err, res) {


        var buf = '';
        res
          .on('error', (err) => {
            throw err
          })
          .on('data', (data) => {
            buf += data
          })
          .on('end', () => {
//            console.log('buffer',buf);
            self.vote = JSON.parse(buf);
            self.contractaddress = self.vote.contractaddress;
            // de rest gaat via de observer van contractaddress
            console.log(self.vote);
            self.vraag = self.vote.vraag;
            self.optie1 = self.vote.optie1;
            self.optie2 = self.vote.optie2;
            self.optie3 = self.vote.optie3;

            self.img1 = self.vote.img1;
            self.img2 = self.vote.img2;
            self.img3 = self.vote.img3;

            self.resttijd = moment.unix(self.vote.endunix).locale('nl').fromNow();
            self.starttijd = moment.unix(self.vote.startunix).locale('nl').fromNow();
          });
        });

        }else{
          console.log('failed to read IPFS object : not available');
        }
      },

      govote: function(tostate){
        console.log('going to state',tostate);
        this.votestate = tostate;
      },

        toCast: function(){
        this.govote('castvote');
      },

      renderchart: function(){
         // create an instance with createElement:
      

      },

      readVoteResults: function() {
        var self = this;
        var MyContract = self.web3.eth.contract(self.contractjson.abi);
        var myContractInstance = MyContract.at(self.contractaddress);

        self.startDate;

        this.voteresults = {};
        this.votekeys = [1, 2, 3];
        this.votekeys.forEach(function(element, index, array) {
          self.voteresults[element] = myContractInstance.voteresults(element).toNumber();
          console.log('votes for ', element, 'count=', self.voteresults[element]);
        });
        console.log("Vote results: ", this.voteresults);

        this.votes1 = this.voteresults[1];
        this.votes2 = this.voteresults[2];
        this.votes3 = this.voteresults[3];

        //this.voteresults = {1: 10, 2: 5, 3: 8};
        
        this.votearray = this.object2array(this.voteresults);
        this.votearray = _.sortBy(this.votearray, "data");
        this.winkey = this.votearray[2].key;

        eval("this.winimg = this.img" + this.winkey);
        eval("this.winvotes = this.votes" + this.winkey);
        eval("this.winoptie = this.optie" + this.winkey);

        this.chartdata = [{
            key: 1,
            value: this.voteresults[1],
            color: this.vote.kleur1,
            highlight: "#FF5A5E",
            label: this.vote.optie1
          },

          {
            key: 2,
            value: this.voteresults[2],
            color: this.vote.kleur2,
            highlight: "#5AD3D1",
            label: this.vote.optie2
          },

          {
            key: 3,
            value: this.voteresults[3],
            color: this.vote.kleur3,
            highlight: "#FFC870",
            label: this.vote.optie3
          }
        ];

      },

      _hascontractaddress: function() {
        var self = this;
        this.contracturl = this.resolveUrl('../../contracts/PoezenVoting.json');
        this.importHref(this.contracturl, function(e) {
          // console.log(e.target.import.body.innerText);
          self.contractjson = JSON.parse(e.target.import.body.innerText);

          // TODO verwijder mij !!! ASAP !
//          self.castVote();

          self.readVoteResults();


        }, function(e) {
          console.log('ERROR!');
        });
      },


      castVote: function() {
        console.log('watwat');

        var self = this;

        self.vote = this.currentchoice;

        console.log(self.account,'casts a vote for option',self.vote,'to contract ',self.contractaddress);

        self.web3.eth.getGasPrice(function(err, result) {

          var MyContract = self.web3.eth.contract(self.contractjson.abi);
          var myContractInstance = MyContract.at(self.contractaddress);


          var gasPrice = result.toNumber(10);

          var options = {
            from: self.account,
            //value: 1 * 1e18,
            gas: 3141590,
            gasPrice: gasPrice,
            nonce: Math.floor(Math.random(999999)) + new Date().getTime(),
          };

          var result = myContractInstance.vote.sendTransaction(self.vote, options,
            function(err, result) {
              if (err != null) {
                console.log(err);
                console.log("ERROR: Transaction didn't go through. See console.");
              } else {
                console.log("Transaction Successful!");
                console.log(result);
              }
            }
          );


        });
      },

      _winkey: function(){
        console.log("NUMMER ", parseInt(this.winkey), " IS WINNAAR");
        var win = parseInt(this.winkey);
        //console.log(this.vote.optiewin);
        //this.winimg = this.voteresults
      },

      object2array: function(input){
      var newarray = [];
      var p = input;
      for (var key in p) {
        if (p.hasOwnProperty(key)) {
          newarray.push({data: p[key], key: key});
          //console.log(newarray);
        }
      };
      return newarray;
    }

    });
  })();
  </script>
</dom-module>
