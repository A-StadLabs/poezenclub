<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/chart-elements/chart-elements.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">

<dom-module id="poes-voting">
  <template>

    <script src="../../bower_components/moment/min/moment-with-locales.min.js"></script>


      <ipfs-upload hidefileinput host="/ip4/109.123.70.141/tcp/5001" ipfs="{{ipfs}}">
      </ipfs-upload>
    <style>
      :host {
        display: block;
        background-color: white;
        height: 100vh;
      }

      .canvaskf {
        @apply(--layout-start);
        box-sizing:border-box;
        padding: 30px;
        background-color: white;
      }

      iron-selector {
        @apply(--layout-vertical);
      }

    .iron-selected {
      background: #ccc;
    }

    .iron-selected::after {
      content: 'momenteel uw stem';
    }

    .square-chart {
      margin-bottom: 20px;
    }

    paper-toolbar {
      background-color: #D18E7D;
      @apply(--layout-horizontal);
      @apply(--layout-wrap);
      @apply(--layout-center-center);
    }

    .keuzeoptie {
      @apply(--layout-horizontal);
      margin-bottom: 10px;
    }

    .bolleke {
      margin-right: 10px;
    }

    </style>
    <template is="dom-if" if="{{voteactive}}">
      <div>
        <paper-toolbar>
          <div class="flex"></div>
          <poes-avatar on-tap="topussybase" poesnr="{{poezenimage}}"></poes-avatar>
        </paper-toolbar>
        <div class="canvaskf">
        <h2 on-tap="renderchart">Wat moet er vanaf maandag in de poezendoos zitten?</h2>
        <chart-pie data="{{chartdata}}" class="square-chart" id="chart"></chart-pie>
        <iron-selector attr-for-selected="key" selected="{{currentchoice}}" on-iron-select="castVote" class="choice">
        <template is="dom-repeat" items="{{chartdata}}">
          <div class="keuzeoptie" key="{{item.key}}">
            <poes-kleurbolleke class="bolleke" kleur="{{item.color}}"></poes-kleurbolleke>
            <div class="label flex">{{item.label}}</div>
            <div>{{item.value}}</div>
          </div>
        </template>
        </iron-selector>
        <p>Bgin van deze stemronde <b>{{starttijd}}</b></p>
        <p>Einde van deze stemronde <b>{{resttijd}}</b></p>
        <p>Maandag gaat de doos enkel open voor poezen die de winnende keuze hebben gemaakt.</p>
        
        </div>
      </div>
    </template>

    <!-- als de voting niet meer actief is -->

    <template is="dom-if" if="{{!voteactive}}">
      <div>
        <paper-toolbar>
          <div class="flex"></div>
          <poes-avatar on-tap="topussybase" poesnr="{{poezenimage}}"></poes-avatar>
        </paper-toolbar>
        <div class="canvaskf">
        <p>Het stemmen is afgelopen.</p>
        <h2 on-tap="renderchart">Wat moet er vanaf maandag in de poezendoos zitten?</h2>
        <chart-pie data="{{chartdata}}" class="square-chart" id="chart"></chart-pie>
        <template is="dom-repeat" items="{{chartdata}}">
          <div class="keuzeoptie" key="{{item.key}}">
            <poes-kleurbolleke class="bolleke" kleur="{{item.color}}"></poes-kleurbolleke>
            <div class="label flex">{{item.label}}</div>
            <div>{{item.value}}</div>
          </div>
        </template>

        <template is="dom-if" if="{{winner}}">
          <p>Jij stemde voor de winnende keuze!</p>
          <paper-button raised>OPEN DE DOOS</paper-button>
        </template>

        <template is="dom-if" if="{{!winner}}">
          <p>Helaas, je hoort niet bij de winnaars.</p>
          <p>Probeer het volgende week nog eens!</p>
        </template>


        </div>
      </div>
    </template>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'poes-voting',

      properties: {
        votekey: {
          type: String,
          observer: 'renderchart'
        },
        voteactive: {
          type: Boolean,
          value: true
        },
        winner: {
          type: Boolean,
          value: true
        },
        contractaddress: {
          type: String,
          observer: "_hascontractaddress"
        },
        voteipfs: {
          type:String
        },
        ipfs: {
          type: String,
          observer: "_ipfschanged"
        }
      },

      attached: function(){
      },

      _ipfschanged: function(){
        var self =this;

        if (this.ipfs){
        this.ipfs.cat(this.voteipfs, function(err, res) {


        var buf = '';
        res
          .on('error', (err) => {
            throw err
          })
          .on('data', (data) => {
            buf += data
          })
          .on('end', () => {
//            console.log('buffer',buf);
            self.vote = JSON.parse(buf);
            self.contractaddress = self.vote.contractaddress;
            // de rest gaat via de observer van contractaddress
            var eindtijd = self.vote.enddate + " " + self.vote.endtime;
            var starttijd = self.vote.enddate + " " + self.vote.endtime;
            //console.log(self.vote);
            //console.log(moment(einddtijd).locale('nl').fromNow());
            self.resttijd = moment(eindtijd).locale('nl').fromNow();
            self.starttijd = moment(starttijd).locale('nl').fromNow();
          });
        });

        }else{
          console.log('failed to read IPFS object : not available');
        }
      },

      topussybase: function(){
        var app = document.getElementById("stage");
        console.log(app);
        app.topussybase();
      },

      renderchart: function(){
         
      },

      readVoteResults: function() {
        var self = this;
        var MyContract = self.web3.eth.contract(self.contractjson.abi);
        var myContractInstance = MyContract.at(self.contractaddress);

        self.startDate

        this.voteresults = {};
        this.votekeys = [1, 2, 3];
        this.votekeys.forEach(function(element, index, array) {
          self.voteresults[element] = myContractInstance.voteresults(element).toNumber();
          console.log('votes for ', element, 'count=', self.voteresults[element]);
        });
        console.log(this.voteresults);

        this.chartdata = [{
            key: 1,
            value: this.voteresults[1],
            color: this.vote.kleur1,
            highlight: "#FF5A5E",
            label: this.vote.optie1
          },

          {
            key: 2,
            value: this.voteresults[2],
            color: this.vote.kleur2,
            highlight: "#5AD3D1",
            label: this.vote.optie2
          },

          {
            key: 3,
            value: this.voteresults[3],
            color: this.vote.kleur3,
            highlight: "#FFC870",
            label: this.vote.optie3
          }
        ];

      },

      _hascontractaddress: function() {
        var self = this;
        this.contracturl = this.resolveUrl('../../contracts/PoezenVoting.json');
        this.importHref(this.contracturl, function(e) {
          // console.log(e.target.import.body.innerText);
          self.contractjson = JSON.parse(e.target.import.body.innerText);

          // TODO verwijder mij !!! ASAP !
//          self.castVote();

          self.readVoteResults();


        }, function(e) {
          console.log('ERROR!');
        });
      },


      castVote: function() {
        var self = this;

        self.vote = this.currentchoice;

        console.log(self.account,'casts a vote for option',self.vote,'to contract ',self.contractaddress);

        self.web3.eth.getGasPrice(function(err, result) {

          var MyContract = self.web3.eth.contract(self.contractjson.abi);
          var myContractInstance = MyContract.at(self.contractaddress);


          var gasPrice = result.toNumber(10);

          var options = {
            from: self.account,
            //value: 1 * 1e18,
            gas: 3141590,
            gasPrice: gasPrice,
            nonce: Math.floor(Math.random(999999)) + new Date().getTime(),
          };

          var result = myContractInstance.vote.sendTransaction(self.vote, options,
            function(err, result) {
              if (err != null) {
                console.log(err);
                console.log("ERROR: Transaction didn't go through. See console.");
              } else {
                console.log("Transaction Successful!");
                console.log(result);
              }
            }
          );


        });
      }

    });
  })();
  </script>
</dom-module>
