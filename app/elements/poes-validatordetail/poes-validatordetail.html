<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="poes-validatordetail">
  <template>

    <iron-localstorage name="{{ref}}" value="{{poes}}" on-iron-localstorage-load="loadpoes" on-iron-localstorage-load-empty="initpoes"></iron-localstorage>
    <iron-localstorage name="poezenimage" value="{{poezenimage}}"></iron-localstorage>
    <iron-localstorage name="poezennaam" value="{{poezennaam}}"></iron-localstorage>
    <iron-localstorage name="poes-validatiecontract" value="{{poescontract}}"></iron-localstorage>

    <style>
      :host {
        display: block;
      }
    </style>

    <template is="dom-if" if="{{valid}}">
      <div><img src="{{poesimage}}" /></div>
      <div>{{poesobject.naam}}</div>
    </template>

    <template is="dom-if" if="{{!valid}}">
      <div><img src="../../images/poezen/empty-poes-01.png" /></div>
       <paper-input-container no-label-float>
            <label class="centertexting">pincode</label>
            <input autofocus class="centertexting"
            is="iron-input"
            prevent-invalid-input
            bind-value="{{enteredpin}}"></paper-input-container>
            <button on-tap="submitpin" class="main">OK</button>
      
    </template>
  
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'poes-validatordetail',

      properties: {
        poes: {
          type: String
        },
        ref: {
          type: String
        },
        valid: {
          type: Boolean,
          value: false
        },
        poesobject: {
          type: Object,
          observer: "poeschanged",
          notify:true
        }
      },

      ready: function() {
        this.mqtt = document.getElementById('lomqtt');
      },
      initpoes: function(){
        this.poesobject = {
          'valid': false,
          'image': "leeg",
          'naam': "lege naam",
          'address': "leeg adres"
        };

      },
      loadpoes: function(){
        try{
          this.poesobject = JSON.parse(this.poes);
          this.fire('poesvalidator-loaded');
        }catch(e){
          console.log('cannot parse poes data from localstorage...',this.poes);
        }
      },
      poeschanged: function(){
        this.poesimage = "../../images/poezen/poes" + this.poesobject.image + ".png";
        this.poes = JSON.stringify(this.poesobject);
        this.valid = this.poesobject.valid;
      },
      
      submitpin: function(){
      var pin = this.enteredpin;
      this.mqtt.send(pin,"validate|"+this.poezennaam+"|"+this.poezenimage+"|"+this.poescontract+"|"+this.pincode+"|"+this.ref, 1);
      },
      
      validationStarted: function(poezennaam,poezenimage,address){
        this.poesobject.naam = poezennaam;
        this.poesobject.image = poezenimage;
        this.poesobject.address = address;
        this.poeschanged();
        console.log('validation started...',this.poesobject);
      }
    });
  })();
  </script>
</dom-module>
