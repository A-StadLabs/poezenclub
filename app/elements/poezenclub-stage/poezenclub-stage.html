<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../poes-aai/poes-aai.html">

<dom-module id="poezenclub-stage">
  <template>
    <style>
      :host {
        display: block;
      }

      neon-animated-pages {
        height: 100%;
      }

      .eighty {
        width: 80%;
      }


      .canvaspink {
        @apply(--canvas-pink);
        @apply(--layout-vertical);
        @apply(--layout-center-center);
      }


      h1 {
        @apply(--theme-font-title);
      }

      h2 {
        @apply(--theme-font-subhead);
        text-align: center;
      }

      p {
        @apply(--theme-font-body1);
      }


      button {
        min-width: 150px;
      }

      .whitespace {
        height: 20px;
      }

      .main {
        @apply(--main-btn);
      }
      .main:hover {
        @apply(--btns-hovercolors);
      }
      .medium {
        @apply(--medium-btn);
      }
      .medium:hover {
        @apply(--btns-hovercolors);
      }
      .small {
        min-width: 100px;
        @apply(--small-btn);
      }
      .small:hover {
        @apply(--btns-altcolors);
      }


      #memberloader {
        padding: 25px;
        border-box:box-sizing;

        width: 250px;
      }



    /*  POEZENSELECTOR  */

    #poezenselector .iron-selected {
      background-color: rgba(255,255,255,0.25);
      border: 2px solid white;
    
    }

    .poesitem {
      background-color: rgba(0,0,0,0.1);
      border-radius: 50%;
      width: 100px;
      height: 100px;
      overflow: hidden;
      margin: 5px;
      border: 2px solid transparent;

    }

    .poesitem img {
      width: 100%;
      height: 100%;
    }

    #poezenselector {
      width: 100vw;
      max-width: 800px;
      @apply(--layout-horizontal);
      @apply(--layout-wrap);
      @apply(--layout-center-center);

    }



    /*  NAME PUSS */

      paper-button {
        text-transform: capitalize;
        font-size: 28px;
        background-color: black;
        color: white;
        --paper-button-ink-color: black;
        --paper-button-flat-keyboard-focus: {
          background-color: black;
          color: white !important;
        };
        --paper-button-raised-keyboard-focus: {
          background-color: black !important;
          color: white !important;
        };
      }
      paper-button:hover {
        background-color: white;
        color: black;
      }

      paper-input-container {
        width: 250px;
        background-color: white;
        margin-bottom: 20px;
        padding: 30px;
      }

      .paper-input-container-0 label, paper-input-char-counter, .paper-input-container-0 input {
      font-family: 'Indie Flower', cursive;
      text-transform: capitalize;
      }


      .validatorz {
        width: 100vw;
        max-width: 600px;
      }

      poes-validatordetail {
        height: 140px;
      }

      hr {
        color: rgba(0,0,0,0.15);
        background-color: rgba(0,0,0,0.25);
        height: 1px;
        outline: none;
        border: 0px;
        margin: 0px;
        padding: 0px;
      }

      .errormsg {
        width: 100%;
        background-color: black;
        height: 50px;
        color: white;
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
      }

      .toppertje {
        width: 100%;
        box-sizing:border-box;
        padding: 20px;
        @apply(--pink-bgcolor);
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-end-justified);
      }

      .valideerbtn {
      outline: 0; 
      margin: 5px 5px 5px 0px;
      box-sizing:border-box;
      border-radius: 8px;
      cursor: pointer;
      @apply(--theme-font-button);
        background-color: transparent;
        border: 1px solid black; 
      padding: 15px 15px 15px 15px;
      font-size: 22px;
    }

    </style>

    <iron-localstorage name="poezenimage" value="{{poezenimage}}"
       on-iron-localstorage-load="poes_loaded"></iron-localstorage>
    <iron-localstorage name="poezennaam" value="{{poezennaam}}" on-iron-localstorage-load="poes_loaded"></iron-localstorage>
<!--    <iron-localstorage name="mypoescontract" value="{{poescontract}}"></iron-localstorage>-->

    <lo-mqtt connected="{{mqttconnected}}" subs
      on-message-received="msgreceived"
      on-mqtt-connected="mqttconnectedfire"
      pincode="{{pincode}}"
      id="lomqtt"></lo-mqtt>

    <poes-validatie id="poesvalidatie" web3="{{web3}}" account="{{account}}" contractaddress="{{contractaddress}}" on-validation-received="validationreceived" validations="{{validations}}"></poes-validatie>

    <poes-membership id="poescontract" web3="{{web3}}" account="{{account}}" contract="LocalsMembership.json" memberstatus="{{memberstatus}}" ismember={{ismember}} on-contract-ready="_poescontractready"></poes-membership>

    <alabs-web3js on-web3-ready="_web3_ready" id="alabsweb3" web3="{{web3}}" accounts="{{accounts}}" account="{{account}}" balance="{{balance}}" connected="{{web3connected}}" provider="http://kingflurkel.dtdns.net:8545"></alabs-web3js>



    <neon-animated-pages selected="{{state}}" 
            entry-animation="{{entryAnimation}}"
            exit-animation="{{exitAnimation}}"
            attr-for-selected="data-route">
      <neon-animatable data-route="selectpussy">
        <div class="canvaspink">
          <div class="errormsg">
            <template is="dom-if" if="{{!web3connected}}">web3 NOT connected</template>
            <h2>Je bent niet correct geconnecteerd. Probeer het later opnieuw.</h2>
            <template is="dom-if" if="{{mqttconnected}}">mqtt connected</template>
          </div>

          <h2>Kies een kat!</h2>
          <iron-selector id="poezenselector" attr-for-selected="poes" on-iron-select="poezenimage_selected" selected="{{poezenimage}}">
            <div class="poesitem" poes="1">
              <img src="../../images/poezen/poes1.png"></div>
            <div class="poesitem" poes="2">
              <img src="../../images/poezen/poes2.png"></div>
            <div class="poesitem" poes="3">
              <img src="../../images/poezen/poes3.png"></div>
            <div class="poesitem" poes="4">
              <img src="../../images/poezen/poes4.png"></div>
            <div class="poesitem" poes="5">
              <img src="../../images/poezen/poes5.png"></div>
            <div class="poesitem" poes="6">
              <img src="../../images/poezen/poes6.png"></div>
            <div class="poesitem" poes="7">
              <img src="../../images/poezen/poes7.png"></div>
            <div class="poesitem" poes="8">
              <img src="../../images/poezen/poes8.png"></div>
            <div class="poesitem" poes="9">
              <img src="../../images/poezen/poes9.png"></div>
            <div class="poesitem" poes="10">
              <img src="../../images/poezen/poes10.png"></div>
            <div class="poesitem" poes="11">
              <img src="../../images/poezen/poes11.png"></div>
            <div class="poesitem" poes="12">
              <img src="../../images/poezen/poes12.png"></div>
            <div class="poesitem" poes="13">
              <img src="../../images/poezen/poes13.png"></div>
            <div class="poesitem" poes="14">
              <img src="../../images/poezen/poes14.png"></div>
          </iron-selector>
          <button on-tap="toNamepussy" class="main">OK</button>
        </div>
      </neon-animatable>

      <neon-animatable data-route="namepussy">
        <div class="canvaspink">
          <h1>Hoe heet jouw poes?</h1>
          <div class="whitespace"></div>
          <paper-input-container no-label-float>
            <input autofocus class="centertexting"
                is="iron-input"
                prevent-invalid-input
                bind-value="{{poezennaam}}"></paper-input-container>
          <button on-tap="poezennaam_selected" class="main">OK</button>
        </div>
      </neon-animatable>
<!--
      <neon-animatable data-route="validate">
        <div class="canvaspink">
          <div class="eighty">
            <h2>Vraag een pincode aan iemand met een gevalideerde poes</h2>
          </div>
          <paper-input-container no-label-float>
            <label class="centertexting">pincode</label>
            <input autofocus class="centertexting"
            is="iron-input"
            prevent-invalid-input
            bind-value="{{enteredpin}}"></paper-input-container>
          <button on-tap="submitpin" class="main">OK</button>
        </div>
      </neon-animatable>
-->

      <neon-animatable data-route="pin">

        <template is="dom-if" if="{{validated}}">
          <div class="canvaspink">
            <p>Jouw pincode</p>
            <h1>{{pincode}}</h1>
            <button class="medium" on-tap="topussybase">Terug</button>
          </div>
        </template>

        <template is="dom-if" if="{{!validated}}">
          <div class="canvaspink">
            <p>Je kan pas iemand valideren als je zelf gevalideerd bent.</p>
            <button class="medium" on-tap="topussybase">Terug</button>
          </div>
        </template>
      </neon-animatable>

      <neon-animatable data-route="incoming">
        <div class="canvaspink">
          <div class="eighty">
            <h2>{{incomingpussyname}}</h2>
            <img src="{{incomingpussypic}}" />
            <p>{{contractaddresstowrite}}</p>
          </div>
          <div class="layout horizontal center">
            <button class="medium" on-tap="topussybase">Annuleren</button>
            <button class="main" on-tap="validateRequest">Valideren</button>
          </div>
        </div>
      </neon-animatable>

      <neon-animatable data-route="openbox">
        <div class="canvaspink">
          <div class="eighty">
            <h2>Check de code op de poezendoos</h2>
          </div>
          <paper-input-container no-label-float>
            <label class="centertexting">pincode</label>
            <input autofocus class="centertexting"
            is="iron-input"
            prevent-invalid-input
            bind-value="{{boxpin}}"></paper-input-container>
        <button on-tap="submitboxpin" class="main">OK</button>
      </div>
    </neon-animatable>
    <neon-animatable data-route="boxisopen">
      <div class="canvaspink">
        <div class="eighty">
          <h2>Neem uw koekje</h2>
        </div>
      <button on-tap="closebox" class="main">Sluit de doos</button>
    </div>
  </neon-animatable>

  <neon-animatable data-route="pussybase">

<!--           <template is="dom-if" if="{{validated}}">
          <div class="toppertje">
          </div>
        </template> -->

    <div class="canvaspink">
      <div class="whitespace"></div>
      <div class="whitespace"></div>


      <h1>{{poezennaam}}</h1>
      <poes-aai catnumber="{{poezenimage}}"></poes-aai>
      <div class="whitespace"></div>

      <template is="dom-if" if="{{!contractaddress}}">
        <poezenclub-loader normal id="memberloader" loadmsg="Je poes wordt geinischeerd"></poezenclub-loader>
      </template>

      <template is="dom-if" if="{{contractaddress}}">
        <template is="dom-if" if="{{validated}}">
          <button on-tap="openbox" class="main">Open de poezendoos</button>
          <button on-tap="tooncode" class="valideerbtn">Valideer iemand anders</button>
        </template>
      <div class="whitespace"></div>
      <div class="whitespace"></div>
      <div class="validatorz vertical layout">
        <poes-validatordetail pincode="{{pincode}}" id="validator1" ref="validator1" poesobject="{{poesobject1}}" on-poesvalidator-loaded="checkvalidationstate" on-validated="checkvalidationstate"></poes-validatordetail>
        <poes-validatordetail pincode="{{pincode}}" id="validator2" ref="validator2" poesobject="{{poesobject2}}" on-poesvalidator-loaded="checkvalidationstate" on-validated="checkvalidationstate"></poes-validatordetail>
      </div>
      </template>

    </div>
  </neon-animatable>

</neon-animated-pages>

</template>
<script>
  (function() {
    'use strict';

    Polymer({
      is: 'poezenclub-stage',

      properties: {
        rout: {
          type: String,
          notify: true,
          observer: 'landed'
        },

        pincode: {
          type: String,
          notify: true
        },

        entryAnimation: {
          type: String
        },

        exitAnimation: {
          type: String
        },

        ismember: {
          type: Boolean,
          notify:true,
          observer: "_ismemberchanged"
        },
        contractaddress: {
          type: String,
          observer: '_contractaddress'          
        },
        state: {
          type:String,
          observer: '_statechanged'          
        },
        validations: {
          type: Number,
          observer: '_validationschanged'          
        }
      },

      ready: function(){
        this.makepincode();
        this.exitAnimation = 'slide-left-animation';
        this.entryAnimation = 'slide-from-right-animation';
        this.state = "selectpussy";
      },

      makepincode: function(){
            this.pincode = (Math.floor(Math.random()*90000) + 10000).toString();
      },

      attached: function(){
       
      },
      _statechanged: function(){
        console.log('state changed to',this.state);
      },
      _ismemberchanged: function(){
        if (this.ismember){
          this.$.poesvalidatie.createContract();
        }
      },
      topussybase: function(){
        this.go('pussybase');
      },

      poes_loaded: function(){
        if (this.poezenimage && this.poezennaam){
          if (this.state == 'selectpussy'){
            this.go('pussybase');
          }
        }
      },

      poezenimage_selected: function(){

      },

      poezennaam_selected: function(){
        this.go('pussybase');
      },

      attached: function(){
        //this.go('selectpussy');
      },

      checkvalidationstate: function(){
        // hier checken of 2 validaties OK zijn.
        // zoja -> toon knop openmaken die doos
        if (this.poesobject1 && this.poesobject1.valid === true && this.poesobject2 && this.poesobject2.valid === true){
          console.log("JE POES IS VALIDE");
          this.validated=true;
        }
      },
      _fixaddress: function(address) {

        function strStartsWith(str, prefix) {
            return str.indexOf(prefix) === 0;
        }

        console.log("Fix address", address);
        if (!strStartsWith(address, '0x')) {
          return ('0x' + address);
        }
        return address;
      },
      validationreceived: function(res){

 

          console.log("Validation received");
          var validatoraddress = this._fixaddress(res.detail.args.validator);
          console.log("...from",validatoraddress);
  
          if (this._fixaddress(this.poesobject1.address) == validatoraddress){
            console.log("is from validator1",this.poesobject1);
            return document.getElementById("validator1").setValidated();
          }
          if (this._fixaddress(this.poesobject2.address) == validatoraddress){
            console.log("is from validator2",this.poesobject2);
            return document.getElementById("validator2").setValidated();
          }
          console.log('unknown validator... ignoring this.');

      },

      _validationschanged: function(){
/*
        if (this.validations > 0){
          this.go('home');          
        }
        if (this.validations > 1){
          console.log('ik zen gevalideerd');
          this.go('home');
          this.validated = true;
        }
        */
      },

      toNamepussy: function() {
        this.go('namepussy');
      },
      mqttconnectedfire: function(){
        console.log("MQTT connected");
        // this.subscribetoPin();
      },

      go: function(tostate){
        console.log('going to state',tostate);
        this.state = tostate;
        switch (tostate){
          case "start":
          case "selectpussy":
            // we come in selectpussy
            //if (this.poezenimage && this.poezennaam){
              this.go('pussybase');
//              this.state = tostate;
            //}
            break;
          case "pussybase":
            //this.checkvalidationstate();
            break;
        }
      },

      landed: function(){
        console.log('landed in state',this.rout);
      },
/*
      submitpin: function(){
        var pin = this.enteredpin;
        this.$.lomqtt.send(pin,"validate|"+this.poezennaam+"|"+this.poesinit+"|"+this.contractaddress+"|"+this.pincode, 2);
        this.$.loader.loadmsg = "Validatie wordt gemined";

        //this.go("start");
      },
  */    
      initpoes: function(){
        //this.go("selectpussy");
      },


      // namepoes: function(){
      //   this.go("namepussy");
      // },


      localpoes: function(){
        //this.go("home");
      },

      validateRequest: function() {
        var self = this;
        // send my pussydetails to the requester..
        this.$.lomqtt.send(this.incomingpin,"validationstarted"+"|"+this.poezenimage+"|"+this.poezennaam+"|"+this.account+"|"+this.incomingref);
        this.$.poesvalidatie.addValidation(this.contractaddresstowrite, function(err, res) {
          console.log("Validatie is started...!");
          //self.go('pussybase');
        });
        this.go("topussybase");
      },

      msgreceived: function(e) {
        console.log("MSG received: ", e.detail);
      },

      openbox: function(){
        //this.go('openbox');
      },

      msgreceived: function(e){
        console.log("MSG received: ",e.detail);

        // Split the motherfucking string!
        var commandarray = e.detail.msg.split("|");
        console.log(commandarray);
        switch (commandarray[0]) {
          case "validate":
            console.log("Meneerke wil zijn poes laten valideren");
            this.incomingpussyname = commandarray[1];
            this.incomingpussypic = "../../images/poezen/poes" + commandarray[2] + ".png";
            this.contractaddresstowrite = commandarray[3];
            this.incomingpin = commandarray[4];
            this.incomingref = commandarray[5];
            this.go('incoming');
            break;
          case "validationstarted":
            var ref = commandarray[4];
            var validator_poezenimage = commandarray[1];
            var validator_poezennaam = commandarray[2];
            var validator_account = commandarray[3];
            this.fire("validationstarted for ref",ref);
            document.getElementById(ref).validationStarted(validator_poezennaam,validator_poezenimage,validator_account);
            break;
          case "validatedone":
            console.log("Validatie is done!");
//            this.$.poezenpages.selected = 6;
            //this.go("home");
            break;
          case "doosisopen":
            console.log("De doos is open");
            //this.$.poezenpages.selected = 12;
            //this.go("boxisopen");
            break;
        };

      },

      _contractaddress:function(){
        console.log('Hemme me hiete een contractaddresske' , this.contractaddress);
        if (!this.contractaddress){
          this.hasadress = false;
        } else {
          this.hasadress = true;
        }
      },

      submitboxpin: function(){
        console.log(this.boxpin);
        var pin = this.boxpin;
        this.$.lomqtt.send("poezendoos/"+pin,"checkContract"+"|"+this.contractaddress+"|"+this.pincode, 2);
        this.go("boxisopen");
      },

      closebox: function(){
        this.$.lomqtt.send("poezendoos/"+this.boxpin,"sluitDoos", 2);
        //this.go("home");
      },

      tooncode: function(){
        this.go("pin");
      }


    });
  })();
  </script>
</dom-module>